# Fastlane configuration for Trivit Travel Tracker

default_platform(:ios)

platform :ios do
  # ============================================
  # Screenshot Generation
  # ============================================

  desc "Generate App Store screenshots on all required device sizes"
  lane :screenshots do
    capture_screenshots(
      project: File.expand_path("../Trivit.xcodeproj", __dir__),
      scheme: "trivit",
      devices: [
        "iPhone 17 Pro Max",      # 6.9" display (required)
        "iPhone 17 Pro",          # 6.3" display
        "iPhone 16e",             # smaller display
        "iPad Pro 13-inch (M5)"   # 13" iPad display
      ],
      languages: ["en-US"],
      output_directory: "./screenshots",
      clear_previous_screenshots: true,
      override_status_bar: true,
      concurrent_simulators: false,
      stop_after_first_error: false,
      skip_open_summary: true
    )
  end

  desc "Generate screenshots for iPhone only (faster)"
  lane :screenshots_iphone do
    capture_screenshots(
      project: File.expand_path("../Trivit.xcodeproj", __dir__),
      scheme: "trivit",
      devices: ["iPhone 17 Pro Max"],
      languages: ["en-US"],
      output_directory: "./screenshots",
      clear_previous_screenshots: true,
      override_status_bar: true,
      skip_open_summary: true
    )
  end

  desc "Generate Apple Watch screenshots via simctl"
  lane :watch_screenshots do
    # Simulator UDIDs (paired: iPhone 17 Pro + Apple Watch Ultra 3)
    phone_udid = "8C97CB6A-E332-4E5A-B56C-D3871E1F68C1"
    watch_udid = "C883FE43-B78B-40CE-A93B-015CDA33BB40"
    output_dir = File.expand_path("../screenshots/en-US", __dir__)
    workspace = File.expand_path("../trivit.xcworkspace", __dir__)

    FileUtils.mkdir_p(output_dir)

    # Boot paired simulators
    UI.message("Booting paired simulators...")
    sh("xcrun simctl boot #{phone_udid} 2>/dev/null || true")
    sh("xcrun simctl boot #{watch_udid} 2>/dev/null || true")
    sleep(5)

    # Build watch app for simulator
    UI.message("Building watch app...")
    sh(
      "xcodebuild build " \
      "-workspace '#{workspace}' " \
      "-scheme 'trivit Watch App' " \
      "-destination 'id=#{watch_udid}' " \
      "-configuration Debug " \
      "ONLY_ACTIVE_ARCH=YES " \
      "2>&1 | tail -5"
    )

    # Find and install the built watch app
    derived_data = File.expand_path("~/Library/Developer/Xcode/DerivedData")
    watch_app = Dir.glob("#{derived_data}/trivit-*/Build/Products/Debug-watchsimulator/trivit Watch App.app").first

    if watch_app
      UI.message("Installing watch app: #{watch_app}")
      sh("xcrun simctl install #{watch_udid} '#{watch_app}'")

      # Launch with sample data
      bundle_id = "com.wouterdevriendt.trivit.watchkitapp"
      sh("xcrun simctl terminate #{watch_udid} #{bundle_id} 2>/dev/null || true")
      sh("xcrun simctl launch #{watch_udid} #{bundle_id} -SampleDataMode YES")
      sleep(5)

      # Take screenshot
      screenshot_path = "#{output_dir}/Apple Watch Ultra 3 (49mm)-01_WatchApp.png"
      sh("xcrun simctl io #{watch_udid} screenshot '#{screenshot_path}'")
      UI.success("Watch screenshot saved to: #{screenshot_path}")
    else
      UI.error("Could not find built watch app in DerivedData")
    end

    # Shutdown simulators
    sh("xcrun simctl shutdown #{watch_udid} 2>/dev/null || true")
    sh("xcrun simctl shutdown #{phone_udid} 2>/dev/null || true")
  end

  # ============================================
  # App Store Connect Upload
  # ============================================

  desc "Upload metadata, screenshots, and app icon to App Store Connect"
  lane :deliver_metadata do |options|
    api_key = get_api_key

    version = options[:app_version] || ENV["APP_VERSION"] || "1.0.0"
    should_submit = options[:submit_for_review] || false

    deliver(
      api_key: api_key,
      app_identifier: "com.wouterdevriendt.trivit",
      app_version: version,
      skip_binary_upload: true,
      skip_screenshots: false,
      skip_metadata: false,
      force: true,
      precheck_include_in_app_purchases: false,
      submit_for_review: should_submit,
      automatic_release: false,
      run_precheck_before_submit: false,
      overwrite_screenshots: true
    )
  end

  desc "Upload everything and submit for review (creates draft)"
  lane :submit_for_review do |options|
    api_key = get_api_key

    version = options[:app_version] || ENV["APP_VERSION"] || "1.0.0"

    deliver(
      api_key: api_key,
      app_identifier: "com.wouterdevriendt.trivit",
      app_version: version,
      skip_binary_upload: true,
      skip_screenshots: false,
      skip_metadata: false,
      force: true,
      precheck_include_in_app_purchases: false,
      submit_for_review: true,
      automatic_release: false,
      run_precheck_before_submit: false,
      overwrite_screenshots: true
    )
  end

  desc "Upload only screenshots"
  lane :upload_screenshots do
    api_key = get_api_key

    deliver(
      api_key: api_key,
      app_identifier: "com.wouterdevriendt.trivit",
      skip_binary_upload: true,
      skip_metadata: true,
      skip_screenshots: false,
      skip_app_version_update: true,
      force: true,
      run_precheck_before_submit: false,
      overwrite_screenshots: true
    )
  end

  desc "Upload only the app icon"
  lane :upload_icon do
    api_key = get_api_key

    deliver(
      api_key: api_key,
      app_identifier: "com.wouterdevriendt.trivit",
      skip_binary_upload: true,
      skip_screenshots: true,
      skip_metadata: true,
      app_icon: "./metadata/app_icon.png",
      force: true,
      submit_for_review: false,
      run_precheck_before_submit: false
    )
  end

  desc "Upload only metadata (no screenshots)"
  lane :upload_metadata_only do |options|
    api_key = get_api_key

    version = options[:app_version] || ENV["APP_VERSION"] || "1.0.0"

    deliver(
      api_key: api_key,
      app_identifier: "com.wouterdevriendt.trivit",
      app_version: version,
      skip_binary_upload: true,
      skip_screenshots: true,
      skip_metadata: false,
      force: true,
      run_precheck_before_submit: false
    )
  end

  desc "Download existing metadata from App Store Connect"
  lane :download_metadata do
    api_key = get_api_key

    deliver(
      api_key: api_key,
      app_identifier: "com.wouterdevriendt.trivit",
      skip_binary_upload: true,
      skip_screenshots: true,
      skip_metadata: false,
      force: true,
      run_precheck_before_submit: false,
      download_metadata: true
    )
  end

  # ============================================
  # Combined Workflows
  # ============================================

  desc "Generate screenshots and upload everything"
  lane :prepare_and_upload do
    screenshots
    deliver_metadata
  end

  desc "Full App Store preparation: icons, screenshots, metadata"
  lane :full_app_store_prep do |options|
    # Generate icons using Python script
    Dir.chdir("../..") do
      sh("python3 scripts/generate_icons.py")
    end

    # Generate screenshots
    screenshots unless options[:skip_screenshots]

    # Upload everything
    deliver_metadata
  end

  # ============================================
  # TestFlight Build & Upload
  # ============================================

  desc "Build and upload to TestFlight"
  lane :testflight_upload do |options|
    api_key = get_api_key

    # Increment build number for both iOS app and watch app
    increment_build_number(
      xcodeproj: File.expand_path("../trivit.xcodeproj", __dir__)
    )

    # Build the app (includes watch app as dependency)
    build_app(
      workspace: File.expand_path("../trivit.xcworkspace", __dir__),
      scheme: "trivit",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "Trivit.ipa",
      include_bitcode: false,
      export_options: {
        compileBitcode: false,
        uploadSymbols: true,
        signingStyle: "automatic",
        teamID: "N324UX8D9M"
      }
    )

    # Upload to TestFlight
    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true,
      skip_submission: true
    )
  end

  desc "Build, upload to TestFlight, and update metadata"
  lane :release do |options|
    version = options[:app_version] || ENV["APP_VERSION"] || "1.0.0"

    # Upload to TestFlight
    testflight_upload

    # Upload metadata
    deliver_metadata(app_version: version)
  end

  # ============================================
  # Helpers
  # ============================================

  private_lane :get_api_key do
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_filepath: ENV["APP_STORE_CONNECT_KEY_PATH"],
      in_house: false
    )
  end
end

# Error handling
error do |lane, exception|
  UI.error("Error in lane '#{lane}': #{exception.message}")
end
