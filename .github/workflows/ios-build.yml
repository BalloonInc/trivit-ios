name: iOS Build

# Uses shared workflow from ios-infra for building the iOS app

on:
  push:
    branches:
      - master
    paths:
      - 'trivit/**'
      - 'trivit Watch App/**'
      - '.github/workflows/ios-build.yml'
  pull_request:
    branches:
      - master
    paths:
      - 'trivit/**'
      - 'trivit Watch App/**'
  workflow_dispatch:

concurrency:
  group: ios-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    uses: wdvr/ios-infra/.github/workflows/ios-build.yml@main
    with:
      bundle_id: com.wouterdevriendt.trivit
      scheme: trivit
      workspace_path: trivit.xcworkspace
      info_plist_path: trivit/Info.plist
      additional_info_plists: 'trivit Watch App/Info.plist'
      # Use manual signing to prevent Xcode from creating new certificates
      # This uses the certificate from DISTRIBUTION_CERTIFICATE_BASE64 secret
      code_signing_identity: 'Apple Distribution'
    secrets:
      APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
      APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
      DISTRIBUTION_CERTIFICATE_BASE64: ${{ secrets.DISTRIBUTION_CERTIFICATE_BASE64 }}
      DISTRIBUTION_CERTIFICATE_PASSWORD: ${{ secrets.DISTRIBUTION_CERTIFICATE_PASSWORD }}
      KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
