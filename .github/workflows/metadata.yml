name: Update App Store Metadata

on:
  workflow_dispatch:
    inputs:
      generate_release_notes:
        description: 'Generate release notes with Claude AI'
        required: false
        default: true
        type: boolean
      upload_screenshots:
        description: 'Upload screenshots'
        required: false
        default: false
        type: boolean
      upload_metadata:
        description: 'Upload metadata to App Store Connect'
        required: false
        default: true
        type: boolean

env:
  DEVELOPER_DIR: /Applications/Xcode_17.0.app/Contents/Developer

jobs:
  # Generate release notes using Claude
  generate-release-notes:
    name: Generate Release Notes
    runs-on: ubuntu-latest
    if: ${{ inputs.generate_release_notes }}
    outputs:
      notes: ${{ steps.generate.outputs.notes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install anthropic

      - name: Generate release notes with Claude
        id: generate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python scripts/generate_release_notes.py

          # Read the generated notes
          NOTES=$(cat fastlane/metadata/en-US/release_notes.txt)

          # Output for next step
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload release notes artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: fastlane/metadata/en-US/release_notes.txt

      - name: Show generated notes
        run: |
          echo "## Generated Release Notes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat fastlane/metadata/en-US/release_notes.txt >> $GITHUB_STEP_SUMMARY

  # Upload metadata to App Store Connect
  upload-metadata:
    name: Upload Metadata to App Store Connect
    runs-on: macos-15
    needs: [generate-release-notes]
    if: ${{ always() && inputs.upload_metadata }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download release notes
        if: ${{ inputs.generate_release_notes }}
        uses: actions/download-artifact@v4
        with:
          name: release-notes
          path: fastlane/metadata/en-US/

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install Fastlane
        run: |
          cd fastlane
          bundle install

      - name: Setup App Store Connect API Key
        run: |
          mkdir -p ~/.private_keys
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}" | base64 -d > ~/.private_keys/AuthKey.p8
          chmod 600 ~/.private_keys/AuthKey.p8

      - name: Upload metadata
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: |
          cd fastlane
          if [ "${{ inputs.upload_screenshots }}" = "true" ]; then
            bundle exec fastlane ios upload_metadata
          else
            bundle exec fastlane ios upload_metadata skip_screenshots:true
          fi

      - name: Cleanup
        if: always()
        run: rm -rf ~/.private_keys

  # Commit updated release notes back to repo
  commit-release-notes:
    name: Commit Release Notes
    runs-on: ubuntu-latest
    needs: [generate-release-notes]
    if: ${{ inputs.generate_release_notes }}
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download release notes
        uses: actions/download-artifact@v4
        with:
          name: release-notes
          path: fastlane/metadata/en-US/

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add fastlane/metadata/
          git diff --staged --quiet || git commit -m "Update release notes via Claude AI

          Generated by: ${{ github.workflow }}
          Run: ${{ github.run_number }}"
          git push origin HEAD:${{ github.ref_name }} || echo "Could not push - may need to pull first"
        continue-on-error: true
