name: CI

on:
  push:
    branches: [main, master, develop, 'feature/**', 'claude/**']
  pull_request:
    branches: [main, master, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DEVELOPER_DIR: /Applications/Xcode_17.0.app/Contents/Developer

jobs:
  # Linting job
  lint:
    name: Lint
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        run: swiftlint lint --reporter github-actions-logging
        continue-on-error: false

  # Swift Format Check
  format:
    name: Format Check
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install swift-format
        run: brew install swift-format

      - name: Check formatting
        run: |
          swift-format lint --recursive Trivit/ TrivitTests/ TrivitUITests/ || {
            echo "::error::Code is not properly formatted. Run 'swift-format format --recursive --in-place Trivit/' to fix."
            exit 1
          }

  # Build and Test - iOS 26
  build-and-test-ios26:
    name: Build and Test (iOS 26)
    runs-on: macos-15
    needs: [lint]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_17.0.app

      - name: Show Xcode version
        run: xcodebuild -version

      - name: List available simulators
        run: xcrun simctl list devices available

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: .build
          key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Resolve packages
        run: |
          if [ -f "Trivit.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved" ]; then
            xcodebuild -resolvePackageDependencies -project Trivit.xcodeproj -scheme Trivit
          fi

      - name: Build
        run: |
          set -o pipefail
          xcodebuild build-for-testing \
            -project Trivit.xcodeproj \
            -scheme Trivit \
            -destination "platform=iOS Simulator,OS=26.0,name=iPhone 16 Pro" \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty

      - name: Run Unit Tests
        run: |
          set -o pipefail
          xcodebuild test \
            -project Trivit.xcodeproj \
            -scheme Trivit \
            -destination "platform=iOS Simulator,OS=26.0,name=iPhone 16 Pro" \
            -testPlan UnitTests \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults-iOS26 \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            | xcpretty --report junit

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-ios26
          path: |
            TestResults-iOS26
            build/reports/

      - name: Generate coverage report
        if: success()
        run: |
          xcrun xccov view --report --json TestResults-iOS26 > coverage.json
          cat coverage.json | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          targets = data.get('targets', [])
          for target in targets:
              name = target.get('name', 'Unknown')
              coverage = target.get('lineCoverage', 0) * 100
              print(f'{name}: {coverage:.1f}%')
          "

  # Build and Test - iOS 17 (backwards compatibility)
  build-and-test-ios17:
    name: Build and Test (iOS 17)
    runs-on: macos-15
    needs: [lint]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_17.0.app

      - name: Build
        run: |
          set -o pipefail
          xcodebuild build-for-testing \
            -project Trivit.xcodeproj \
            -scheme Trivit \
            -destination "platform=iOS Simulator,OS=17.5,name=iPhone 15 Pro" \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty

      - name: Run Unit Tests
        run: |
          set -o pipefail
          xcodebuild test \
            -project Trivit.xcodeproj \
            -scheme Trivit \
            -destination "platform=iOS Simulator,OS=17.5,name=iPhone 15 Pro" \
            -testPlan UnitTests \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults-iOS17 \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            | xcpretty --report junit

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-ios17
          path: TestResults-iOS17

  # UI Tests - iPhone (separate job for longer-running tests)
  ui-tests-iphone:
    name: UI Tests (iPhone)
    runs-on: macos-15
    needs: [build-and-test-ios26]
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_17.0.app

      - name: Boot Simulator
        run: |
          xcrun simctl boot "iPhone 16 Pro" || true

      - name: Run iPhone UI Tests
        run: |
          set -o pipefail
          xcodebuild test \
            -project Trivit.xcodeproj \
            -scheme Trivit \
            -destination "platform=iOS Simulator,OS=26.0,name=iPhone 16 Pro" \
            -testPlan UITests \
            -resultBundlePath UITestResults-iPhone \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            | xcpretty
        continue-on-error: true

      - name: Upload iPhone UI test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ui-test-results-iphone
          path: UITestResults-iPhone

  # UI Tests - iPad
  ui-tests-ipad:
    name: UI Tests (iPad)
    runs-on: macos-15
    needs: [build-and-test-ios26]
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_17.0.app

      - name: Boot iPad Simulator
        run: |
          xcrun simctl boot "iPad Pro 13-inch (M4)" || true

      - name: Run iPad UI Tests
        run: |
          set -o pipefail
          xcodebuild test \
            -project Trivit.xcodeproj \
            -scheme Trivit \
            -destination "platform=iOS Simulator,OS=26.0,name=iPad Pro 13-inch (M4)" \
            -testPlan iPadUITests \
            -resultBundlePath UITestResults-iPad \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            | xcpretty
        continue-on-error: true

      - name: Upload iPad UI test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ui-test-results-ipad
          path: UITestResults-iPad

  # macOS Tests
  test-macos:
    name: Test (macOS)
    runs-on: macos-15
    needs: [lint]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_17.0.app

      - name: Build for macOS
        run: |
          set -o pipefail
          xcodebuild build-for-testing \
            -project Trivit.xcodeproj \
            -scheme Trivit \
            -destination "platform=macOS" \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty

      - name: Run macOS Unit Tests
        run: |
          set -o pipefail
          xcodebuild test \
            -project Trivit.xcodeproj \
            -scheme Trivit \
            -destination "platform=macOS" \
            -testPlan UnitTests \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults-macOS \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            | xcpretty --report junit
        continue-on-error: true

      - name: Upload macOS test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-macos
          path: TestResults-macOS

  # macOS UI Tests
  ui-tests-macos:
    name: UI Tests (macOS)
    runs-on: macos-15
    needs: [test-macos]
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_17.0.app

      - name: Run macOS UI Tests
        run: |
          set -o pipefail
          xcodebuild test \
            -project Trivit.xcodeproj \
            -scheme Trivit \
            -destination "platform=macOS" \
            -testPlan macOSUITests \
            -resultBundlePath UITestResults-macOS \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            | xcpretty
        continue-on-error: true

      - name: Upload macOS UI test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ui-test-results-macos
          path: UITestResults-macOS

  # Build for all platforms
  build-all-platforms:
    name: Build All Platforms
    runs-on: macos-15
    needs: [build-and-test-ios26]
    strategy:
      matrix:
        include:
          - platform: iOS
            destination: generic/platform=iOS
          - platform: watchOS
            destination: generic/platform=watchOS
          - platform: macOS
            destination: platform=macOS
          - platform: visionOS
            destination: generic/platform=visionOS
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_17.0.app

      - name: Build for ${{ matrix.platform }}
        run: |
          set -o pipefail
          xcodebuild build \
            -project Trivit.xcodeproj \
            -scheme Trivit \
            -destination "${{ matrix.destination }}" \
            -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty
        continue-on-error: ${{ matrix.platform == 'visionOS' }}

  # Documentation generation
  docs:
    name: Generate Documentation
    runs-on: macos-15
    if: github.ref == 'refs/heads/main'
    needs: [build-and-test-ios26]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_17.0.app

      - name: Generate DocC documentation
        run: |
          xcodebuild docbuild \
            -project Trivit.xcodeproj \
            -scheme Trivit \
            -destination "generic/platform=iOS" \
            -derivedDataPath DerivedData \
            || echo "DocC build failed, continuing..."

      - name: Upload documentation
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: documentation
          path: DerivedData/Build/Products/Debug-iphoneos/Trivit.doccarchive

  # Dependency audit
  security-audit:
    name: Security Audit
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for known vulnerabilities
        run: |
          echo "Checking for security issues..."
          # Check for hardcoded secrets
          if grep -rn "API_KEY\|SECRET\|PASSWORD\|TOKEN" --include="*.swift" Trivit/ 2>/dev/null | grep -v "// "; then
            echo "::warning::Potential hardcoded secrets found"
          fi
          echo "Security audit complete"
